import subprocess
from time import sleep


def run_cmd(cmd_list):
    child = subprocess.Popen(cmd_list, stdout=subprocess.PIPE)
    streamdata = child.communicate()[0]
    ret = child.returncode
    return streamdata.decode(), ret


def exploit(binary, randomize):
    """
        Check if the corrected source code is still vulnerable
    """
    with open('key') as key:
        content, code = run_cmd([binary, 's'])
        if content.find(key.read()) > 0:
            print('Your API is leaking the key!\n')
            return True

    out_1, _ = run_cmd([binary, ''])
    sleep(1)
    out_2, _ = run_cmd([binary, ''])

    if out_1 == out_2:
        print('Your IV  does not seems to be random\n')
        return True

    return False
