import re
import subprocess


def run_cmd(cmd_list):
    child = subprocess.Popen(cmd_list, stdout=subprocess.PIPE)
    streamdata = child.communicate()[0]
    ret = child.returncode
    return streamdata.decode(), ret


def exploit(binary, randomize):
    """
        Check if the corrected source code is still vulnerable
    """
    out, _ = run_cmd((binary, 'test', '/accounts/1/details'))
    if 'balance' in out.lower():
        print("It's still possible to get account id 1")
        return True

    out, _ = run_cmd((binary, 'test1', '/accounts/new'))
    reg = r'Your account (.*) has been successfully created'
    account_id = re.search(reg, out, re.I).group(1)

    out, _ = run_cmd((binary, 'test2', '/accounts/{}/details'.format(account_id)))
    if 'balance' in out.lower():
        print("User test2 can access account id {} owned by test1".format(account_id))
        return True

    return False
